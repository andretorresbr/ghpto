## -------------------------------------------------------------------------
## CONFIGURAÇÃO OTIMIZADA PARA PURPLE TEAM & WAZUH
## -------------------------------------------------------------------------

# Primeiro, deleta todas as regras antigas para começar limpo
-D

# Define o tamanho do buffer (Aumentar para evitar perda de logs em ataques rápidos)
-b 8192

# Em caso de falha do auditd, o sistema continua rodando (0=silent, 1=printk, 2=panic)
-f 1

## -------------------------------------------------------------------------
## 1. MONITORAMENTO DE EXECUÇÃO DE COMANDOS (A "Caixa Preta")
## Isso vai logar TODO comando executado no servidor. É o "ouro" da forense.
## -------------------------------------------------------------------------
-a always,exit -F arch=b64 -S execve -k audit_exec
-a always,exit -F arch=b32 -S execve -k audit_exec

## -------------------------------------------------------------------------
## 2. MONITORAMENTO DE IDENTIDADE E CREDENCIAIS (Seu caso de uso atual)
## Detecta leitura ou escrita em arquivos de senha e grupos.
## -p wa (Write/Attribute change) - FIM
## -p r (Read) - Espionagem
## -------------------------------------------------------------------------
-w /etc/group -p wa -k identity_modification
-w /etc/passwd -p wa -k identity_modification
-w /etc/gshadow -p wa -k identity_modification
-w /etc/shadow -p rwa -k shadow_access
-w /etc/security/opasswd -p wa -k identity_modification

## -------------------------------------------------------------------------
## 3. MONITORAMENTO DE SUDOERS (Escalação de Privilégio)
## -------------------------------------------------------------------------
-w /etc/sudoers -p wa -k scope_change
-w /etc/sudoers.d/ -p wa -k scope_change

## -------------------------------------------------------------------------
## 4. MONITORAMENTO DE PERSISTÊNCIA (Cron e Systemd)
## -------------------------------------------------------------------------
-w /etc/cron.d/ -p wa -k cron_modification
-w /etc/cron.daily/ -p wa -k cron_modification
-w /etc/cron.hourly/ -p wa -k cron_modification
-w /etc/cron.weekly/ -p wa -k cron_modification
-w /etc/cron.monthly/ -p wa -k cron_modification
-w /etc/crontab -p wa -k cron_modification
-w /var/spool/cron/crontabs/ -p wa -k cron_modification

## -------------------------------------------------------------------------
## 5. MONITORAMENTO DE RECONHECIMENTO (Comandos suspeitos)
## Atacantes usam isso logo que entram.
## -------------------------------------------------------------------------
-w /usr/bin/whoami -p x -k recon
-w /usr/bin/id -p x -k recon
-w /usr/bin/wget -p x -k download_tool
-w /usr/bin/curl -p x -k download_tool
-w /usr/bin/ncat -p x -k network_tool
-w /usr/bin/nc -p x -k network_tool
-w /bin/nc -p x -k network_tool

## -------------------------------------------------------------------------
## 6. SELF-DEFENSE (Detecta se tentarem parar o log)
## -------------------------------------------------------------------------
-w /var/log/audit/ -k audit_log_tampering
-w /etc/audit/ -p wa -k audit_config_change
