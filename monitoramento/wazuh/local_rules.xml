<!--=============================================================================================================================================================================================-->
<!--=============================================================================================================================================================================================-->

<group name="windows, windows_security, active_directory,">

<!-- Testado em ambiente Active Directory com nível funcional Windows Server 2025 + Wazuh v4.14.1 -->
<!-- Regras de sintaxe deste arquivo: https://documentation.wazuh.com/current/user-manual/ruleset/ruleset-xml-syntax/rules.html -->


<!--=============================================================================================================================================================================================-->

<!-- Detecta possível Kerberoasting usando os logs de Security do DC -->
  <rule id="110002" level="12">
    <if_sid>60103</if_sid>
    <options>no_full_log</options>
    <field name="win.system.eventID">^4769$</field>
    <field name="win.eventdata.ticketEncryptionType">^0x17$</field>
    <field name="win.eventdata.targetUserName" type="pcre2" negate="yes">\$$|^SYSTEM$</field>
    <description>Active Directory: Possível ataque de Kerberoasting (RC4 Ticket Request) do usuário $(win.eventdata.targetUserName) na conta $(win.eventdata.serviceName)</description>
    <mitre>
      <id>T1558.003</id>
    </mitre>
  </rule>
  
<!-- Detecta alterações no atributo ServicePrincipalName (SPN) de objetos do AD usando os logs de Security do DC -->
  <rule id="110003" level="12">
    <if_sid>60103</if_sid>
    <options>no_full_log</options>
    <field name="win.system.eventID">^5136$</field>
    <field name="win.eventdata.attributeLDAPDisplayName">^servicePrincipalName$</field>
    <field name="win.eventdata.subjectUserName" negate="yes">^SYSTEM$</field>
    <description>Active Directory: Alteração de SPN ($(win.eventdata.attributeValue)) do objeto $(win.eventdata.objectDN) realizado por $(win.eventdata.subjectUserName) </description>
    <info type="text">Verifique o campo data.win.system.message / Operation Type, para saber se é inclusão ou exclusão</info>
    <mitre>
      <id>T1098</id>
    </mitre>
  </rule>

<!--=============================================================================================================================================================================================-->

<!-- Detecta possível AS-REP Roasting (Kerberos Pre-Auth Disabled) usando os logs de Security do DC -->
  <rule id="110004" level="12">
    <if_sid>60103</if_sid>
    <options>no_full_log</options>
    <field name="win.system.eventID">^4768$</field>
    <field name="win.eventdata.preAuthType">^0$|^0x0$</field>
    <field name="win.eventdata.status">^0x0$</field>
    <field name="win.eventdata.targetUserName" type="pcre2" negate="yes">\$$</field>
    <field name="win.eventdata.ipAddress" type="pcre2" negate="yes">^127\.0\.0\.1$|^::1$|^-$</field>
    <description>Active Directory: Possível AS-REP Roasting (Kerberos Pre-Auth Disabled) contra usuário $(win.eventdata.targetUserName). Origem: $(win.eventdata.ipAddress)</description>
    <mitre>
      <id>T1558.004</id>
    </mitre>
  </rule>

<!-- Detecta quando em um objeto é setado o "Do not Require Kerberos Pre-Authentication usando os logs de Security do DC -->
  <rule id="110005" level="12">
    <if_sid>60103</if_sid>
    <options>no_full_log</options>
    <field name="win.system.eventID">^4738$</field>
    <field name="win.system.message" type="pcre2">(?i)'Don't Require Preauth'\s+-\s+Enabled</field>
    <description>Active Directory: Pré-autenticação Kerberos desabilitada na conta $(win.eventdata.targetUserName) pelo usuário $(win.eventdata.subjectUserName)</description>
    <mitre>
      <id>T1558.004</id>
    </mitre>
  </rule>

<!--=============================================================================================================================================================================================-->

<!-- Detecta os eventos básicos de falha de autenticação do NTLM (EventID 4625) e Kerberos (EventID 4771) -->
<rule id="110006" level="1">
    <if_sid>60104,60122</if_sid>
    <field name="win.system.eventID">^4625$|^4771$</field>
    <options>no_log</options>
    <description>Auditoria: Coletor de Falhas de Autenticação (NTLM 4625 / Kerberos 4771)</description>
</rule>

<!-- Detecta password spray (diversas tentativas de login com falha vindo de um mesmo IP de origem) usando os logs de Security do DC. O threshold configurado é: 15 tentativas dentro de 2 minutos (120s) -->
<!-- Baseia-se na regra anterior (110006) para detectar tanto password spray NTLM quanto Kerberos -->
<rule id="110007" level="12" frequency="15" timeframe="120" ignore="60">
    <if_matched_sid>110006</if_matched_sid>
    <options>no_full_log</options>
    <same_field>win.eventdata.ipAddress</same_field>
    <field name="win.eventdata.ipAddress" type="pcre2" negate="yes">^127\.0\.0\.1$|^::1$|^-$</field>
    <description>Active Directory: Possível Password Spray (NTLM/Kerberos). O IP $(win.eventdata.ipAddress) gerou pelo menos 15 falhas de autenticação em menos de 2 minutos.</description>
    <mitre>
      <id>T1110.003</id>
    </mitre>
</rule>

<!-- Detecta um password spray que tenha tido sucesso, isto é, uma autenticação válida -->
<!-- Alerta caso haja um IP que disparou a regra anterior (110007) nos últimos 5 minutos (300s) e tenha conseguido autenticar com sucesso -->
<!-- SID 60106 refere-se a logons com sucesso no Windows -->
<rule id="110008" level="14" timeframe="600" ignore="10">
    <if_sid>60106,60118,60200,92652</if_sid>
    <if_matched_sid>110007</if_matched_sid>
    <options>no_full_log</options>
    <same_field>win.eventdata.ipAddress</same_field>
    <field name="win.eventdata.targetUserName" type="pcre2" negate="yes">^ANONYMOUS LOGON$|.*\$|^SYSTEM$</field>
    <description>Active Directory: CRÍTICO - Autenticação com SUCESSO do usuário $(win.eventdata.targetUserName) detectada após Password Spray vindo de $(win.eventdata.ipAddress). O usuário foi bloqueado.</description>
    <mitre>
        <id>T1078.002</id>
    </mitre>
</rule>

<!--=============================================================================================================================================================================================-->

<!-- Detecta alterações em grupos Tier 0  -->
<!-- Referência de ativos Tier 0: https://specterops.github.io/TierZeroTable -->
<rule id="110009" level="12">
    <if_sid>60113</if_sid>
    <options>no_full_log</options>
    <field name="win.system.eventID">^4728$|^4729$|^4732$|^4733$|^4756$|^4757$</field>
    <list field="win.eventdata.targetUserName" lookup="match_key">etc/lists/tier0_groups</list>
    <description>Active Directory: Alteração de membro no grupo privilegiado $(win.eventdata.targetUserName) realizada pelo usuário $(win.eventdata.subjectUserName). O usuário adicionado/removido foi o $(win.eventdata.memberName)</description>
    <info type="text">Verificar o campo data.win.system.message para saber se é inclusão ou exclusão</info>
    <mitre>
        <id>T1098</id>
        <id>T1078</id>
    </mitre>
</rule>

<!--=============================================================================================================================================================================================-->

<!-- Monitoramento de contas especiais (break the glass): ações feitas na conta  -->
<rule id="110010" level="15">
    <if_group>windows</if_group>
    <options>no_full_log</options>
    <field name="win.system.eventID" type="pcre2" negate="yes">^4688$</field>
    <field name="win.eventdata.targetUserName" type="pcre2">(?ix)^(
        breaktheglass_da|
        btg_da
    )(?:$|@)
    </field>
    <description>Active Directory: CRÍTICO - Atividade detectada na conta especial $(win.eventdata.targetUserName). Verifique imediatamente os detalhes da operação realizada. Em caso de não haver justificativa para a ação, desativá-la imediatamente.</description>
    <mitre>
        <id>T1078</id>
        <id>T1098</id>
    </mitre>
</rule>

<!--=============================================================================================================================================================================================-->

<!-- Monitoramento de configuração de Unconstrained Delegation -->
<rule id="110011" level="14">
    <if_sid>60110,60121</if_sid>
    <options>no_full_log</options>
    <field name="win.system.eventID">^4738$|^4742$</field>
    <field name="win.system.message" type="pcre2">(?i)'Trusted For Delegation'\s*-\s*Enabled</field>
    <description>Active Directory: Objeto $(win.eventdata.targetUserName) foi configurado para UNCONSTRAINED DELEGATION pelo usuário $(win.eventdata.subjectUserName). Risco alto de comprometimento do domínio caso o $(win.eventdata.targetUserName) seja comprometido.</description>
    <mitre>
        <id>T1098</id>
        <id>T1558</id>
    </mitre>
</rule>

<!-- Monitoramento de configuração de Constrained Delegation -->
<rule id="110012" level="12">
    <if_sid>60110,60121</if_sid>
    <options>no_full_log</options>
    <field name="win.system.eventID">^4738$|^4742$</field>
    <field name="win.system.message" type="pcre2">(?ix)(?:
        'Trusted\sTo\sAuthenticate\sFor\sDelegation'\s*-\s*Enabled|
        AllowedToDelegateTo:\s+(?!-)
    )</field>
    <description>Active Directory: Objeto $(win.eventdata.targetUserName) foi configurado para CONSTRAINED DELEGATION pelo usuário $(win.eventdata.subjectUserName). Risco alto de comprometimento do objeto que sofreu delegação (ver atributo msDS-AllowedToDelegateTo) caso o $(win.eventdata.targetUserName) seja comprometido.</description>
    <mitre>
        <id>T1098</id>
        <id>T1558</id>
    </mitre>
</rule>

<!-- Monitoramento de configuração de RBCD -->
<rule id="110013" level="13">
    <if_sid>60229</if_sid>
    <options>no_full_log</options>
    <field name="win.eventdata.attributeLDAPDisplayName" type="pcre2">(?i)msDS-AllowedToActOnBehalfOfOtherIdentity</field>
    <field name="win.eventdata.operationType">%%14674</field> <!-- alerta apenas adição de RBCD e não sua remoção -->
    <description>Active Directory: Configuração de RBCD (Resource-Based Constrained Delegation) detectada no objeto $(win.eventdata.objectDN), realizada pelo usuário usuário $(win.eventdata.subjectUserName) . Verifique o atributo PrincipalsAllowedToDelegateToAccount do objeto.</description>
    <mitre>
        <id>T1098</id>
        <id>T1558</id>
    </mitre>
</rule>

<!--=============================================================================================================================================================================================-->

<!-- Monitoramento de ataques de DCSync -->
<rule id="110014" level="15" ignore="10">
    <if_group>windows</if_group>
    <options>no_full_log</options>
    <field name="win.system.eventID">^4662$</field>
    <field name="win.eventdata.properties" type="pcre2">\{1131f6aa-9c07-11d1-f79f-00c04fc2dcd2\}</field>
    <!-- Ignora DCSync vindo do usuário MSOL (sincronismo do Entra ID Connect) -->
    <!-- <field name="win.eventdata.subjectUserName" type="pcre2" negate="yes">^MSOL_7dd2c274f37e$</field> -->
    <description>Active Directory: CRÍTICO - Ataque DCSync detectado. O usuário $(win.eventdata.subjectUserName) solicitou replicação de segredos, extraindo a base de hashes de senhas do AD.</description>
    <mitre>
        <id>T1003.006</id>
    </mitre>
</rule>

<!-- Essa regra descarta DCSync vindo de Domain Controllers. Isso porque não é possível negar uma CDB List no Wazuh. -->
<rule id="110015" level="0">
    <if_sid>110014</if_sid>
    <list field="win.eventdata.subjectUserName" lookup="match_key">etc/lists/domain_controllers</list>
    <description>[Descarte] Legítimo: Replicação (DCSync) realizada por um Domain Controller confiável. O alerta será descartado (level 0)</description>
</rule>

<!-- Detecta a extração do arquivo NTDS.dit usando o Sysmon -->
<rule id="110016" level="15">
    <if_group>sysmon_event1</if_group>
    <options>no_full_log</options>
    <field name="win.eventdata.originalFileName" type="pcre2">(?i)^ntdsutil\.exe$</field>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)\sifm\s+.*create</field>
    <description>CRÍTICO: Dump do AD (ntds.dit) no host $(win.system.computer) pelo usuário $(win.eventdata.user) via Ntdsutil IFM detectado. Comando executado: $(win.eventdata.commandLine)</description>
    <mitre>
        <id>T1003.003</id>
    </mitre>
</rule>

<!--=============================================================================================================================================================================================-->

<!-- Monitoramento de acessos à Tier 0 exclusivamente por usuários Tier 0 -->
<!-- Alerta por autenticações em servidores Tier 0. -->
<rule id="110017" level="12" ignore="30">
    <if_group>windows</if_group>
    <options>no_full_log</options>
    <field name="win.system.eventID">^4624$</field>
    <field name="win.eventdata.logonType">^2$|^10$</field>
    <list field="win.system.computer" lookup="match_key">etc/lists/t0_servers</list>
    <field name="win.eventdata.targetUserName" type="pcre2" negate="yes">\$$</field>
    <field name="win.eventdata.targetUserName" type="pcre2" negate="yes">^ANONYMOUS LOGON$|^SYSTEM$|^NETWORK SERVICE$|^LOCAL SERVICE$|^DWM-|^UMFD-</field>
    <description>Active Directory: CRÍTICO - Acesso Admin (RDP/Console) em T0 por $(win.eventdata.targetUserName).</description>
    <mitre>
        <id>T1078</id>
    </mitre>
</rule>
<!-- Descarta o alerta quando o usuário for da Tier 0 -->
<rule id="110018" level="0">
    <if_sid>110017</if_sid>
    <list field="win.eventdata.targetUserName" lookup="match_key">etc/lists/t0_users</list>
    <description>[Descarte] Logon Tier 0 Autorizado.</description>
</rule>

<!-- Alerta por execuções de comandos de usuários não Tier 0 em ativos Tier 0 -->
<rule id="110019" level="12" ignore="10">
    <if_group>windows</if_group>
    <if_sid>67027</if_sid>
    <options>no_full_log</options>
    <field name="win.system.eventID">^4688$</field>
    <list field="win.system.computer" lookup="match_key">etc/lists/t0_servers</list>
    <field name="win.eventdata.subjectUserName" type="pcre2" negate="yes">\$$|^SYSTEM$|^NETWORK SERVICE$|^LOCAL SERVICE$|^DWM-|^UMFD-</field>
    <description>TIER 0 VIOLATION: O usuário $(win.eventdata.subjectUserName) (Não-Tier 0) executou comando no servidor Tier 0 $(win.system.computer). Processo: $(win.eventdata.newProcessName)</description>
    <mitre>
        <id>T1059</id>
        <id>T1021.006</id>
    </mitre>
</rule>
<!-- Descarta o alerta quando o usuário for da Tier 0 -->
<rule id="110020" level="0">
    <if_sid>110019</if_sid>
    <list field="win.eventdata.subjectUserName" lookup="match_key">etc/lists/t0_users</list>
    <description>[Descarte] Execução autorizada por Admin Tier 0.</description>
</rule>

<!--=============================================================================================================================================================================================-->

<!-- Monitoramento de eventos relacionados ao Windows Defender -->

<!-- Desativação do Windows Defender Real-Time Protection (EventID 5001) -->
<rule id="110022" level="13">
    <if_sid>62152</if_sid>
    <options>no_full_log</options>
    <field name="win.system.eventID">^5001$</field>
    <description>Windows Defender: CRÍTICO - O Windows Defender Real-Time Protection foi desativado no host $(win.system.computer).</description>
    <mitre>
        <id>T1562.001</id>
    </mitre>
    <group>pci_dss_5.1,pci_dss_10.2.6,gdpr_IV_35.7.d,nist_800_53_SI.3,</group>
</rule>

<!-- Desativação do Windows Defender Tamper Protection (EventID 5007) -->
<rule id="110023" level="15">
    <if_sid>62154</if_sid>
    <options>no_full_log</options>
    <field name="win.eventdata.new Value" type="pcre2">HKLM.*TamperProtection\s*=\s*0x4</field>
    <description>Windows Defender: CRÍTICO - Tamper Protection desativado no host $(win.system.computer).</description>
    <mitre><id>T1562.001</id></mitre>
</rule>

<!-- Adição de pasta em exclusão no Windows Defender (EventID 5007) -->
<rule id="110024" level="12">
    <if_sid>62154</if_sid>
    <options>no_full_log</options>
    <field name="win.eventdata.new Value" type="pcre2">HKLM.*Exclusions.*.*=\s*0x0</field>
    <description>Windows Defender: ALERTA - Uma nova exclusão foi adicionada ao Windows Defender no host $(win.system.computer).</description>
    <mitre>
        <id>T1562.001</id>
    </mitre>
</rule>

<!--=============================================================================================================================================================================================-->

<!-- Monitoramento de alterações suspeitas de configuração de serviços (Windows Event Log, Wazuh, Sysmon) -->
<rule id="110025" level="13">
    <if_sid>61104</if_sid>
    <options>no_full_log</options>
    <field name="win.eventdata.param1" type="pcre2">Windows Event Log|Wazuh|Sysmon</field>
    <description>Comportamento suspeito: O serviço de segurança $(win.eventdata.param1) foi modificado no host $(win.system.computer). Status alterado de '$(win.eventdata.param2)' para '$(win.eventdata.param3)'.</description>
    <mitre>
        <id>T1562.001</id>
    </mitre>
</rule>

<!-- Monitoramento de paradas suspeitas de serviços (Windows Event Log, Wazuh, OssecSvc, Sysmon) -->
<!-- Editar o /var/ossec/etc/ossec.conf e setar <agents_disconnection_time>5m</agents_disconnection_time> e <agents_disconnection_alert_time>0s</agents_disconnection_alert_time>. Isso faz um alerta disparar se o agente passar 5 min sem se conectar -->
<rule id="110026" level="13">
    <if_group>windows</if_group>
    <options>no_full_log</options>
    <field name="win.system.eventID">^7036$|^7011$</field>
    <field name="win.eventdata.param1" type="pcre2">(?i)^(Windows Event Log|Wazuh.*|Sysmon.*)$</field>
    <field name="win.eventdata.param2" type="pcre2">stopped</field>
    <description>Comportamento suspeito: O serviço do Windows $(win.eventdata.param1) foi PARADO no host $(win.system.computer). Verifique se o host não sofreu reboot ou shutdown recentemente (regra 67018).</description>
    <mitre>
        <id>T1562.001</id>
        <id>T1489</id> 
    </mitre>
</rule>

<!-- Eleva o nível do alerta das regras 504 e 506 (Wazuh Agent parado) -->
<rule id="110027" level="12">
    <if_sid>504,506</if_sid>
    <options>no_full_log</options>
    <description>CRÍTICO: Wazuh Agent interrompido (possível tentativa de evasão ou sabotagem). Acesse o host e investigue os logs no canal System, verificando se o serviço Wazuh ou Windows Event Log foram parados manualmente (EventID=7036).</description>
    <mitre>
    <id>T1562.001</id>
    </mitre>
</rule>

<!-- Alerta vindo de SYSLOG (rule 1) de monitoramento de script local (mapeado no agent.conf / localfile ServiceGuard.log ) -->
<rule id="110028" level="12">
    <if_sid>1</if_sid> 
    <regex>CRITICO: O servico \S+ estava PARADO</regex>
    <description>DEFESA ATIVA: Serviço crítico (EventLog/Wazuh) foi reiniciado automaticamente pelo script ServiceGuard.</description>
    <mitre>
      <id>T1562.002</id>
    </mitre>
</rule>

<!-- Monitoramento de limpeza de logs -->
<rule id="110029" level="14">
    <if_sid>83200,63104</if_sid>
    <options>no_full_log</options>
    <field name="win.system.eventID">^1102$|^104$</field>
    <description>Comportamento suspeito: O canal de log $(win.logFileCleared.channel) foi limpo manualmente pelo usuário $(win.logFileCleared.subjectUserName) em $(win.system.computer).</description>
    <mitre>
        <id>T1070.001</id>
    </mitre>
</rule>

<!--=============================================================================================================================================================================================-->

<!-- Monitoramento do arquivo honeypot CriaDiscoRede_Estacoes.ps1 no SYSVOL -->
<rule id="110030" level="12">
    <if_group>windows</if_group>
    <options>no_full_log</options>
    <field name="win.system.eventID">^4663$</field>  
    <field name="win.eventdata.objectName" type="pcre2">(?i)CriaDiscoRede_Estacoes\.ps1$</field>
    <field name="win.eventdata.accessMask" type="pcre2">0x1$|%%4416</field> 
    <description>[Honeypot] O script CriaDiscoRede_Estacoes.ps1, que possui credenciais inválidas, foi LIDO por $(win.eventdata.subjectUserName).</description>
    <mitre>
        <id>T1059.001</id>
    </mitre>
</rule>

<!-- Monitoramento de tentativa de ação da conta honeytoken svc_wkstasks -->
<rule id="110031" level="15">
    <if_group>windows</if_group>
    <options>no_full_log</options>
    <field name="win.system.eventID">^4624$|^4625$|^4768$|^4769$|^4771$|^4776$|^4648$</field>
    <field name="win.eventdata.targetUserName" type="pcre2">(?i)svc_wkstasks</field>
    <description>[Honeypot] HONEYTOKEN ACIONADO - Tentativa de uso da conta isca $(win.eventdata.targetUserName) detectada na origem $(win.eventdata.ipAddress).</description>
    <mitre>
        <id>T1078</id>
        <id>T1003</id>
        <id>T1566</id>
    </mitre>
</rule>

<!--=============================================================================================================================================================================================-->

<rule id="110032" level="12">
  <if_group>sysmon_event1</if_group>
  <options>no_full_log</options>
  <list field="win.eventdata.originalFileName" lookup="match_key">etc/lists/rmm_tools</list>
  <description>[LOLRMM] Ferramenta de administração remota $(win.eventdata.originalFileName) detectada no host $(win.system.computer) executada pelo usuário $(win.eventdata.user).</description>
  <mitre>
    <id>T1219</id>
  </mitre>
</rule>

<rule id="110033" level="12">
  <if_group>sysmon_event1</if_group>
  <options>no_full_log</options>
  <list field="win.eventdata.description" lookup="match_key">etc/lists/rmm_tools-description</list>
  <description>[LOLRMM] Ferramenta de administração remota $(win.eventdata.description) detectada no host $(win.system.computer) executada pelo usuário $(win.eventdata.user).</description>
  <mitre>
    <id>T1219</id>
  </mitre>
</rule>

<rule id="110034" level="12">
  <if_group>sysmon_event_22</if_group>
  <options>no_full_log</options>
  <list field="win.eventdata.queryName" lookup="match_key">etc/lists/rmm_domains</list>
  <description>[LOLRMM] Comunicação de rede do usuário $(win.eventdata.user) no host $(win.system.computer) com domínio suspeito (categoria Administração Remota): $(win.eventdata.queryName)</description>
  <mitre>
    <id>T1071.001</id>
  </mitre>
</rule>

<!--=============================================================================================================================================================================================-->

<rule id="110099" level="0">
    <if_sid>67027</if_sid>
    <list field="win.eventdata.newProcessName" lookup="match_key">etc/lists/process-whitelist</list>
    <description>[Descarte] Tuning: Processo legítimo ignorado (listado na CDB process-whitelist).</description>
</rule>

<rule id="110098" level="0">
    <if_sid>92213</if_sid>
    <field name="win.eventdata.targetFilename" type="pcre2">(?i)__PSScriptPolicyTest_.*\.ps(1|m1|d1)$</field>
    <description>[Descarte] Tuning: Arquivo de teste de política do PowerShell (Legítimo).</description>
</rule>

</group>

<!--=============================================================================================================================================================================================-->
<!--=============================================================================================================================================================================================-->

<group name="local,syslog,sshd,">
    <rule id="5763" level="12" frequency="8" timeframe="120" ignore="60" overwrite="yes">
    <if_matched_sid>5760</if_matched_sid>
    <same_source_ip />
    <options>no_full_log</options>
    <description>ALERTA CRITICO: Brute force SSH detectado no servidor $(hostname) com origem do IP $(srcip). O IP de origem foi bloqueado por 2 minutos no servidor $(hostname).</description>
    <mitre>
        <id>T1110</id>
    </mitre>
    <group>authentication_failures,pci_dss_11.4,gdpr_IV_35.7.d,</group>
    </rule>
</group>

<!--=============================================================================================================================================================================================-->
<!--=============================================================================================================================================================================================-->
